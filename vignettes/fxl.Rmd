---
title: "Faux Excel (fxl) Charting in R"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{Faux Excel (fxl) Charting in R}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{=html}
<style>
img {
    border: 0;
}
#toc ul.nav li ul li {
    display: none;
    max-height: none;
}

#toc ul.nav li.active ul li  {
    display: block;
    max-height: none;
}

#toc ul.nav li ul li ul li {
    max-height: none;
    display: none !important;
}

#toc ul.nav li ul li.active ul li {
    max-height: none;
    display: block !important;
}
</style>
```
# The rationale for *fxl* and Novel Methods

Single-case research designs involve the presentation of empirical data across experimental conditions to visually draw inferences regarding the effects of environmental manipulations on observed behavior. The empirical data featured in these designs are presented using various that have been shaped by decades of research and practice in behavior analysis. Many of these conventions are highly specialized and are not natively supported in any existing software package (e.g., phase change lines being drawn across multiple individual plots). Even though methods exist for accommodating these conventions in spreadsheet software, these are all tedious and effortful and subsequent modifications typically require additional human interaction to edit. Various scripts and macros have been suggested to streamline these efforts; however, these are at best incomplete at best and a security threat at worst. Indeed, most organizations disable the use of macros by default for all users. The *fxl* package was designed to meet this gap in available and accessible tools.

## Primary Goals of *fxl* Package

Various methods exist for visualizing the results of clinical work and research using single-case designs and visual analysis. However, most of these approaches are limited in flexibility, reproducibility, and security. The methods and design of the package have been designed to accomplish several goals.

### Goal #1: Transparency and Replicability

Visualizations of single-case designs are carefully constructed from empirical data to support visual analysis. This is potentially problematic from a reproducibility standpoint, as these types of figures are traditionally constructed by hand and cannot be fully reproduced without direct access to the exact spreadsheet from which the figure was developed. Furthermore, even with direct access to the exact spreadsheet, changes cannot be audited and documented over time and this further hinders efforts at transparency.

The *fxl* package was designed to address these shortcomings by leveraging the transparency and replicability of the *R Statistical Program* and supporting the drawing of single case design figures using *R* syntax only. This syntax-forward approach also allows researchers to pre-register their design specifications and visualizations in an attempt to better distinguish exploratory vs hypothesis testing research.

### Goal #2: Access to Single Case Conventions

Manual construction of single case plots, even when using templates, entails an array of monotonous and tedious tasks that must be performed by hand. Various features of these figures must be generated by hand using methods that were not originally designed for such purposes (e.g., combining multiple plots into a single plot). This is not an efficient use of clinical or research time.

The package was developed to provide access to methods specifically designed to feature the conventions not supported elsewhere. These methods are provided 'out-of-the-box' to make these conventions more accessible and more efficient for researchers and clinicians.

### Goal #3: Support for Dynamic Reporting

Attempts to scale interventions and clinical/educational programming based on single case designs and visual analysis have traditionally been difficult due to the efforts and consideration required for visual analysis. Generally, most clinicians working with many cases typically track and monitor the results of intervention using individual spreadsheets. That is, much of this work is unnecessarily duplicated and this introduces a significant source of inefficiency at scale.

The *fxl* package was designed to be compatible with *RMarkdown* and *Quarto* to support dynamic reports that can simultaneously visualize progress for multiple individuals (e.g., students in a classroom) as well as multiple groups (e.g., across classrooms in a grade). Specifically, *fxl* was designed to be able to be used in a way that scaled effectively in ways that other, earlier methods for drawing single case design figures did not. Similarly, this approach can be used to draw up-to-date reports, drawn in lossless quality, and built to scale as new students are added to the caseload.

## Syntax and General Code Structure

The *fxl* package was constructed to use a functional approach to *R* and makes heavy use of the \`\|\>\` pipe operator to streamline the expressiveness of the syntax. For users of the *ggplot2* package, the general logic and workflow are almost identical. That is, a general object is created (e.g., 'fxl' class in *fxl* as opposed to 'ggproto' in *ggplot2*) and layers are added to the object to tailor what is drawn upon the figure (e.g., markers, lines, annotations) and adjust other features of the figure (e.g., spacing, coordinate limits).

### Rationale for Distinct Package/Style

The decision not to simply build upon the well-established *ggplot2* package was one that was not made lightly or at haste. Indeed, I tried, and certain conventions in single case design and visual analysis simply are so idiosyncratic that no existing plotting system could accommodate all of them natively. I got about 80% of where I needed to get with *ggplot2*, but ultimately, I had to create a custom approach to design an approach that would be useful for single case design users.

The high degree of overlap in terms of workflow (i.e., functional style), function calls (e.g., scr\_\*), and features was deliberate and there were several reasons for doing so. First, the initial design used *ggplot2* as a base and focused on extending the package to support conventions common in single-case research designs. However, low-level conventions regarding how individual facets were drawn limited options for drawing cross-plot features (e.g., staggered phase change lines across plots). Considerable work was done here, but a dedicated drawing algorithm using base *R* methods needed to be developed to fully incorporate all desired plotting features. Simply put, the functionality didn't seem to exist (without a deep re-write) and the project reached a point where it was easier to make something specific rather than making something designed to be very general (i.e., *ggplot2* into something so specialized).

Second, the pragmatic and stylistic features of *ggplot2* (to whatever degree helpful) were deliberately maintained to assist users of *ggplot2* in using the package. To be clear, this was not done to create an alternative or competitor to *ggplot2*. If functionality for drawing annotations across multiple plots in a figure (i.e., staggered phase change lines, free drawing of text/shapes/images) were to be added to *ggplot2*, I'd merge all of this into an extension because that would be easier to manage over time.

### Core Plotting Object

The core plotting object for the figure is produced using the *scr_plot* call with the required arguments. The *required* arguments include a valid dataframe with relevant data as well as a list of aesthetics that direct the engine on how to visualize that data (e.g., which data corresponds with the x-axis). Other arguments are also available to further customize the plot (e.g., margins), but only these are *required* to produce the core object.

#### Required: *x*

The *x* argument represents the domain of the data (e.g., sessions, days) and is a required argument. The core object will return an error if this is not set within the aesthetics object (i.e., *var_map*). The entry is simply the name of the column in the data frame.

#### Required: y

The *y* argument represents the ordinate of the data (e.g., frequency, rate of behavior) and is a required argument. The core object will return an error if this is not set within the aesthetics object (i.e., *var_map*). The entry is simply the name of the column in the data frame.

#### Optional: p

The *p* argument represents the phases that correspond with *x* and *y* coordinates (e.g., baseline, intervention). This is an optional argument, given that there are multiple ways that different lines/points can be drawn upon plots/figures. Normally, this is most useful for distinguishing between *sets* of data points that are similar but disconnected in a figure (e.g., different baseline periods in an A-B-A-B reversal design). The entry is simply the name of the column in the data frame.

#### Optional: facet

The *facet* argument represents the individual *panels* or *subplots* within the greater figure. That is, these are typically distinguished by varying participants/classrooms (i.e., multiple baseline across subjects) or varying targets/settings (e.g., multiple baseline within an individual). This is critical for visualizing baseline logic but the facet argument is an optional one because not all designs require more than one facet. The entry is simply the name of the column in the data frame.

#### Example:

An example of this is provided below:

```{r structure_core, fig.width=7, fig.height=4}
suppressPackageStartupMessages(library(fxl))

scr_plot(
  Gilroyetal2015, # Data frame (long format)
  aesthetics = var_map(
    x = Session, # Column name for x-axis values
    y = Responding, # Column name for y-axis values
    p = Condition, # Column name for phases associated with x-y coordinates
    facet = Participant # Column name distinguishing individual plots/facets
  )
)
```

### Adding Drawing Layers to Core Plotting Object

The core plotting object alone will rarely provide a sufficient visualization of the supplied data and layers can be added to the object to further refine the end result. That is, despite the core object being provided with x-y coordinate data, no specific instructions to draw are provided without specific instructions. Layers to add the drawing of markers (*scr_points*), lines (*scr_lines*), or alter any other relevant feature of the figure must be specified in the call.

Note: The *order* in which the layers are added are relevant. That is, those layers added earlier in the chain will be drawn earlier and likewise those added later will be drawn later.

#### Data Layers

Across each of the data layers, there is a corresponding *x* and *y* argument at minimum. However, there are various options and overrides available.

##### Data Layer Settings

###### Color (*color*)

TODO

###### Line Type (*lty*)

TODO

###### Line Width (*size*)

TODO

###### Aesthetices (*mapping*)

TODO

##### Points: *scr_points*

TODO

##### Lines: *scr_lines*

TODO

##### Images: *scr_images*

TODO

##### Example:

An example that builds from the previous example and adds points and lines is provided below:

```{r structure_layers, fig.width=8, fig.height=4}
scr_plot(
  Gilroyetal2015,
  aesthetics = var_map(
    x = Session,
    y = Responding,
    p = Condition,
    facet = Participant
  )
) |>
  scr_points(cex = 2) |> # plot points, using x/y from aesthetics
  scr_lines(size = 1) # plot line, using x/y from aesthetics
```

As an added note, it warrants stating clearly that the sequence (i.e., the call must begin with *scr_plot*) and chain of calls are relevant to how the program works (i.e., all are linked together by the native *R* pipe operator '\|\>'). The pipe operator should be used to connect calls in the sequence; however, the historical '%\>%' operator from *magittr* could also be used if desired (but is not generally recommended). Additionally, the *order* of layers is also relevant because layers added earlier with be drawn earlier (i.e., lower *z-index*) and layers added later will be drawn later (i.e., higher *z-index*).

### Customizing Labels and Axes

The default behavior of the drawing engine is to draw axes using the names supplied to x-y coordinate variables and use the domains and ranges specified by the data supplied. Occasionally, the visualization of these data may be more understandable to set to a different set of extremes (i.e., round to a number maximum divisible by 10; e.g., 100 instead of 97). Various calls exist to override the range of axes (i.e., *scr_xoverride*, *scr_yoverride*), the labels for those axes (i.e., *scr_xlabel*, *scr_ylabel*), and the title of the overall figure (i.e., *scr_title*).

An example that builds from the previous examples and customizes the axes titles, ticks, and figure title is provided below:

```{r structure_labels, fig.width=8, fig.height=4}
scr_plot(
  Gilroyetal2015,
  aesthetics = var_map(
    x = Session,
    y = Responding,
    p = Condition,
    facet = Participant
  )
) |>
  scr_points(cex = 2) |>
  scr_lines(size = 1) |>
  scr_xoverride(c(0.25, 27.5),
    xticks = 1:27,
    xtickslabs = as.character(1:27)
  ) |> # manually override x-axis (make extra room for labels) and specify ticks
  scr_yoverride(c(-5, 105),
    yticks = c(0, 50, 100),
    ytickslabs = as.character(c(0, 50, 100)),
  ) |> # manually override y-axis and tick interval (tick for every 10 units)
  scr_xlabel("Session") |> # Override x-axis label (bottom only shown by default)
  scr_ylabel("Percent Accuracy") |> # Override y-axis label (centered, leftmost label)
  scr_title("Rates of Acquisition across Participants")
```

### Drawing Phase Change Lines and Phase Labels

Single-case design conventions require clear delineations between conditions to visualize behavior in the presence/absence of specific ecological manipulations. Both the styling and positioning of these features are central to how single-case data are typically presented. The *fxl* package features several methods that allow a high level of flexibility in these regards.

The *scr_label_facet* method provides a way to label individual facets. Specifically, this is a feature used to present the reader with information about how different panels relate to one another. For example, the three panels in a figure may refer to three distinct individuals and labels would be necessary to distinguish one participant from another.

The *scr_label_phase* method draws text like the previous call; however, this method draws text annotations *within* a panel/facet. This is a more common convention used in single-case design whereby the labels for shared phases across a design are drawn on the topmost panel only. As such, this call is distinct from the prior one in that the user must specify *which panel* to draw the text upon as well as where.

The *scr_plines_mbd* is perhaps the most specialized of all the methods included in *fxl*. This method provides a means of drawing lines that distinguish phases within and between facets. Specifically, a list of line lists is used to specify how the user wants to distinguish phases across the entirety of the figure. These are typically very useful when demonstrations of control are performed using a lagged introduction of the independent variable (i.e., multiple baseline design).

An example that builds from the previous examples and each of these conventions is provided below:

```{r structure_lines, fig.width=8, fig.height=4}
scr_plot(
  Gilroyetal2015,
  aesthetics = var_map(
    x = Session,
    y = Responding,
    p = Condition,
    facet = Participant
  )
) |>
  scr_points(cex = 2) |>
  scr_lines(size = 1) |>
  scr_xoverride(c(0.25, 27.5),
    xticks = 1:27,
    xtickslabs = as.character(1:27)
  ) |>
  scr_yoverride(c(-5, 105),
    yticks = c(0, 50, 100),
    ytickslabs = as.character(c(0, 50, 100)),
  ) |>
  scr_label_facet( # Draw a label for each facet (i.e., plot)
    cex = 1.5,
    adj = 1,
    y = 25, # Specify a common height for all labels
    labels = list(
      "Andrew" = list(x = 27), "Brian" = list(x = 27), "Charles" = list(x = 27)
    ) # Labels to draw, for each respective facet, with specific args (i.e., x)
  ) |>
  scr_label_phase(
    facet = "Andrew", # plot labels on specific facet
    cex = 1.25,
    adj = 0.5,
    y = 120,
    labels = list( # list of labels to draw (will use assigned key for label)
      "Baseline" = list(x = 2.5), "Treatment" = list(x = 9),
      "Maintenance" = list(x = 19), "Generalization" = list(x = 26)
    )
  ) |>
  scr_plines_mbd(
    lines = list( # plot linked phase lines (note: drawn from top through bottom)
      "A" = list(
        "Andrew" = list(x1 = 4.5, y1 = 100),
        "Brian" = list(x1 = 11.5, y1 = 100),
        "Charles" = list(x1 = 18.5, y1 = 100, y2 = -5)
      ),
      "B" = list(
        "Andrew" = list(x1 = 13.5, y1 = 100),
        "Brian" = list(x1 = 20.5, y1 = 100),
        "Charles" = list(x1 = 23.5, y1 = 100, y2 = -5)
      ),
      "C" = list(
        "Andrew" = list(x1 = 23.5, y1 = 100),
        "Brian" = list(x1 = 23.5, y1 = 100),
        "Charles" = list(x1 = 23.5, y1 = 100, y2 = -5)
      )
    )
  ) |>
  scr_xlabel("Session") |>
  scr_ylabel("Percent Accuracy") |>
  scr_title("Rates of Acquisition across Participants")
```

### Saving Figure Output

The user can choose to save the output of *fxl* printed to the screen by using the *scr_save* method and specifying the relevant arguments. The options for drawing figures and saving to file afforded by the *R* ecosystem are numerous and various vector and raster options exist. Users can specify the format of the image, its dimensions, and various other format-specific arguments (e.g., pixel density for rasters).

An example that completes the previous examples and saves the figure to a file is provided below:

```{r structure_save, eval=FALSE}
scr_plot(
  Gilroyetal2015,
  aesthetics = var_map(
    x = Session,
    y = Responding,
    p = Condition,
    facet = Participant
  )
) |>
  scr_points(cex = 2) |>
  scr_lines(size = 1) |>
  scr_xoverride(c(0.25, 27.5),
    xticks = 1:27,
    xtickslabs = as.character(1:27)
  ) |>
  scr_yoverride(c(-5, 105),
    yticks = c(0, 50, 100),
    ytickslabs = as.character(c(0, 50, 100)),
  ) |>
  scr_label_facet(
    cex = 1.5,
    adj = 1,
    y = 25,
    labels = list(
      "Andrew" = list(x = 27),
      "Brian" = list(x = 27),
      "Charles" = list(x = 27)
    )
  ) |>
  scr_label_phase(
    facet = "Andrew",
    cex = 1.25,
    adj = 0.5,
    y = 120,
    labels = list(
      "Baseline" = list(x = 2.5), "Treatment" = list(x = 9),
      "Maintenance" = list(x = 19), "Generalization" = list(x = 26)
    )
  ) |>
  scr_plines_mbd(
    lines = list(
      "A" = list(
        "Andrew" = list(x1 = 4.5, y1 = 100),
        "Brian" = list(x1 = 11.5, y1 = 100),
        "Charles" = list(x1 = 18.5, y1 = 100, y2 = -5)
      ),
      "B" = list(
        "Andrew" = list(x1 = 13.5, y1 = 100),
        "Brian" = list(x1 = 20.5, y1 = 100),
        "Charles" = list(x1 = 23.5, y1 = 100, y2 = -5)
      ),
      "C" = list(
        "Andrew" = list(x1 = 23.5, y1 = 100),
        "Brian" = list(x1 = 23.5, y1 = 100),
        "Charles" = list(x1 = 23.5, y1 = 100, y2 = -5)
      )
    )
  ) |>
  scr_xlabel("Session") |>
  scr_ylabel("Percent Accuracy") |>
  scr_title("Rates of Acquisition across Participants") |>
  scr_save(
    name = "NewFileName.svg",
    format = "svg",
    units = "in",
    height = 6,
    width = 9
  ) # Save options for figure
```

# Publication-quality *fxl* Examples

Several examples of figures constructed using *fxl* and data from peer-reviewed works are provided in the sections below. The source code necessary to reproduce all figures here is provided in the 'demo' folder of the source repository.

## Gilroy et al. (2021)

### Results in Concurrent Reversal Design

```{r ex_gilroy_et_al_2021, fig.width=9, fig.height=6, echo=FALSE}
data <- Gilroyetal2021

scr_plot(
  data,
  aesthetics = var_map(
    x = Session,
    y = Responding,
    p = Condition,
    facet = Participant
  ),
  mai = c(
    0.375,
    0.375,
    0.175,
    0.1
  ),
  omi = c(
    0.25,
    0.25,
    0.25,
    0.25
  )
) |>
  scr_xoverride(
    c(0.5, 25),
    xticks = 1:25
  ) |>
  scr_yoverride(
    list(
      "John" = list(
        y0 = -1,
        y1 = 20,
        yticks = c(0, 5, 10, 15, 20)
      ),
      "Anthony" = list(
        y0 = -0.5,
        y1 = 10,
        yticks = c(0, 5, 10)
      ),
      "Charles" = list(
        y0 = -1,
        y1 = 20,
        yticks = c(0, 5, 10, 15, 20)
      )
    ),
    ydelta = 5
  ) |>
  scr_points(
    cex = 2
  ) |>
  scr_points(
    cex = 2,
    pch = 2,
    mapping = list(
      x = Session,
      y = Reinforcers
    )
  ) |>
  scr_lines() |>
  scr_lines(
    lty = 2,
    mapping = list(
      x = Session,
      y = Reinforcers
    )
  ) |>
  scr_label_phase(
    facet = "John",
    cex = 1.25,
    adj = 0.5,
    y = 20,
    labels = list(
      "Baseline" = list(
        x = 2
      ),
      "FR-Lowest" = list(
        x = 5
      ),
      "Baseline" = list(
        x = 8
      ),
      "FR-Inelastic" = list(
        x = 11
      ),
      "FR-Elastic" = list(
        x = 14
      ),
      "FR-Inelastic" = list(
        x = 18
      )
    )
  ) |>
  scr_label_facet(
    cex = 1.5,
    adj = 1,
    x = 25,
    labels = list(
      "John" = list(
        y = 2.5
      ),
      "Anthony" = list(
        y = 12
      ),
      "Charles" = list(
        y = 25
      )
    )
  ) |>
  scr_plines_mbd(lines = list(
    "A" = list(
      "John" = list(
        x1 = 3.5,
        y1 = 20
      ),
      "Anthony" = list(
        x1 = 3.5,
        y1 = 10
      ),
      "Charles" = list(
        x1 = 3.5,
        y1 = 20,
        y2 = -1
      )
    ),
    "B" = list(
      "John" = list(
        x1 = 6.5,
        y1 = 20
      ),
      "Anthony" = list(
        x1 = 6.5,
        y1 = 10
      ),
      "Charles" = list(
        x1 = 8.5,
        y1 = 20,
        y2 = -1
      )
    ),
    "C" = list(
      "John" = list(
        x1 = 9.5,
        y1 = 20
      ),
      "Anthony" = list(
        x1 = 9.5,
        y1 = 10
      ),
      "Charles" = list(
        x1 = 11.5,
        y1 = 20,
        y2 = -1
      )
    ),
    "D" = list(
      "John" = list(
        x1 = 12.5,
        y1 = 20
      ),
      "Anthony" = list(
        x1 = 16.5,
        y1 = 10
      ),
      "Charles" = list(
        x1 = 16.5,
        y1 = 20,
        y2 = -1
      )
    ),
    "E" = list(
      "John" = list(
        x1 = 15.5,
        y1 = 20,
        y2 = 2
      ),
      "Anthony" = list(
        x1 = 22.5,
        y1 = 10
      ),
      "Charles" = list(
        x1 = 19.5,
        y1 = 20,
        y2 = -1
      )
    )
  )) |>
  scr_xlabel("Session") |>
  scr_ylabel("         Frequency (Responses, Reinforcers Delivered)") |>
  scr_title("Individual Evaluations of Reinforcer Efficacy and Elasticity across Reinforcers") |>
  scr_legend(
    panel = "John",
    position = "right",
    legend = c(
      "Responses Observed",
      "Reinforcers Produced"
    ),
    col = c(
      "black",
      "black"
    ),
    pt_bg = c(
      "black",
      "black"
    ),
    lty = c(
      1,
      2
    ),
    pch = c(
      19,
      2
    ),
    bg = c(
      "black",
      "black"
    ),
    bty = "n",
    pt_cex = 2.25,
    cex = 1.25,
    text_col = "black",
    horiz = FALSE,
    box_lty = 0
  )
```

## Gilroy et al. (2019)

### Results of Functional Analysis

```{r ex_gilroy_et_al_at, fig.width=9, fig.height=6, echo=FALSE}
data <- Gilroyetal2019

scr_plot(
  data,
  aesthetics = var_map(
    x = Session,
    y = CTB,
    p = Condition
  ),
  mai = c(0.5, 0.5, 0.1, 0.5),
  omi = c(0.25, 0.25, 0.25, 0.25)
) |>
  scr_xoverride(c(-.5, 15)) |>
  scr_yoverride(c(-.05, 2),
    yticks = c(0, 0.5, 1, 1.5, 2),
    ytickslabs = c(
      "0",
      "0.5",
      "1",
      "1.5",
      "2"
    )
  ) |> # manually override y-axis
  scr_lines(size = 1) |> # plot lines, using x/y from aesthetics
  scr_points(
    cex = 2, # plot points, using x/y from aesthetics
    pch = list( # override point marker types (match FA conventions)
      "Toy Play" = 16,
      "Attention" = 22,
      "Demand" = 24,
      "Tangible" = 8
    ),
    fill = list( # override point marker colors (match FA conventions)
      "Toy Play" = "black",
      "Attention" = "white",
      "Demand" = "white",
      "Tangible" = "black"
    )
  ) |>
  scr_xlabel("Session") |>
  scr_ylabel("Combined Target Behavior (Per Minute)") |>
  scr_title("Analog Functional Analysis") |>
  scr_legend(
    position = "topright", # Specify legend location
    legend = c(
      "Toy Play",
      "Attention",
      "Demand",
      "Tangible"
    ),
    col = c(
      "black",
      "black",
      "black",
      "black"
    ),
    pt_bg = c(
      "black",
      "white",
      "white",
      "black"
    ),
    lty = c(
      1,
      1,
      1,
      1
    ),
    pch = c(
      16,
      22,
      24,
      8
    ),
    bty = "n",
    pt_cex = 2.25,
    cex = 1.25,
    text_col = "black",
    horiz = FALSE,
    box_lty = 0
  ) |>
  scr_save(
    name = "../man/figures/fafigure.svg",
    format = "svg",
    units = "in",
    height = 6,
    width = 9
  )
```

### Results in Modified Multiple Baseline Design

```{r ex_gilroy_et_al_mbd, fig.width=9, fig.height=6, echo=FALSE}
current_data <- Gilroyetal2019Tx
current_data$Condition <- paste0(current_data$Condition, current_data$PhaseNum)
current_data$Function <- current_data$Participant
current_data$AFCR <- current_data$FCR
current_data$EFCR <- current_data$FCR2

scr_plot(current_data,
  aesthetics = var_map(
    x = Session,
    y = CTB,
    p = Condition,
    facet = Function
  ),
  mai = c(0.375, 0.375, 0.25, .25),
  omi = c(0.25, 0.25, 0.25, 0.25)
) |>
  scr_yoverride(
    list(
      "Attention" = list(
        y0 = -0.125,
        y1 = 3,
        yticks = c(0, 1, 2, 3)
      ),
      "Demand" = list(
        y0 = -0.125,
        y1 = 3,
        yticks = c(0, 1, 2, 3)
      )
    )
  ) |>
  scr_xoverride(
    c(-1, 100),
    xdelta = 10,
    xticks = c(
      1,
      seq(10, 100,
        by = 10
      )
    )
  ) |>
  scr_lines(
    size = 1
  ) |>
  scr_lines(
    mapping = list(
      x = Session,
      y = AFCR
    ),
    size = 1,
    lty = 2
  ) |>
  scr_lines(
    mapping = list(
      x = Session,
      y = EFCR
    ),
    size = 1,
    lty = 3
  ) |>
  scr_points(
    fill = "white",
    pch = 21
  ) |>
  scr_points(
    mapping = list(
      x = Session,
      y = AFCR
    ),
    cex = 1,
    pch = 20,
    fill = "black"
  ) |>
  scr_points(
    mapping = list(
      x = Session,
      y = EFCR
    ),
    cex = 0.75,
    pch = 24,
    fill = "black"
  ) |>
  scr_plines_mbd(
    lines = list(
      "A" = list(
        "Attention" = list(
          x1 = 13.5,
          y1 = 3.15,
          y2 = -0.125
        ),
        "Demand" = list(
          x1 = 20,
          y1 = 3,
          y2 = -0.125
        )
      )
    )
  ) |>
  scr_plines(
    lty = 1,
    lines = list(
      "Attention" = list(
        "A" = list(
          x1 = 25.5,
          y1 = 3
        ),
        "B" = list(
          x1 = 26.5,
          y1 = 3
        ),
        "C" = list(
          x1 = 60.5,
          y1 = 3,
          lty = 3
        ),
        "D" = list(
          x1 = 76.5,
          y1 = 3,
          lty = 3
        )
      ),
      "Demand" = list(
        "A" = list(
          x1 = 34.5,
          y1 = 3
        ),
        "B" = list(
          x1 = 37.5,
          y1 = 3
        ),
        "C" = list(
          x1 = 41.5,
          y1 = 3
        ),
        "D" = list(
          x1 = 50.5,
          y1 = 3,
          lty = 3
        ),
        "E" = list(
          x1 = 72.5,
          y1 = 3,
          lty = 3
        )
      )
    )
  ) |>
  scr_label_facet(
    cex = 1.25,
    adj = 1,
    y = 3.15,
    x = 100,
    labels = list(
      "Attention",
      "Demand"
    )
  ) |>
  scr_label_phase(
    facet = "Attention",
    cex = 0.6,
    adj = 0.5,
    y = 3,
    labels = list(
      "Baseline" = list(
        x = 14,
        y = 3.5
      ),
      "FCR-A + EXT" = list(
        x = 19
      ),
      "FCR-A + EXT" = list(
        x = 32
      ),
      "Parent Implementation" = list(
        x = 68.5
      ),
      "Generalization" = list(
        x = 82
      ),
      "Problem Behavior" = list(
        x = 7,
        y = 1.8
      ),
      "FCR-A" = list(
        x = 20,
        y = 2.5
      ),
      "Add FCR\nOptions" = list(
        x = 31,
        y = 2.5
      )
    )
  ) |>
  scr_label_phase(
    facet = "Attention",
    cex = 0.6,
    adj = 0.5,
    labels = list(
      "5s" = list(
        x = 39,
        y = 2.4
      ),
      "Schedule Thinning" = list(
        x = 54,
        y = 2.4
      ),
      "300s" = list(
        x = 75,
        y = 2.4
      )
    )
  ) |>
  scr_label_phase(
    facet = "Demand",
    cex = 0.6,
    adj = 0.5,
    y = 3,
    labels = list(
      "FCR-E + EXT" = list(
        x = 30,
        y = 3.45
      ),
      "FCR-A P = 0.1" = list(
        x = 36,
        y = 2,
        srt = 90
      ),
      "FCR-A/E + EXT" = list(
        x = 47,
        y = 3.35
      ),
      "Parent Implementation" = list(
        x = 58.5
      ),
      "Generalization" = list(
        x = 78
      ),
      "FCR-E" = list(
        x = 24,
        y = 2.5
      ),
      "FCR-A\nP = 0.1\n200% SR" = list(
        x = 46,
        y = 2
      )
    )
  ) |>
  scr_label_phase(
    facet = "Demand",
    cex = 0.6,
    adj = 0.5,
    y = 1.375,
    labels = list(
      "1" = list(
        x = 30
      ),
      "Demand Fading" = list(
        x = 56
      ),
      "6" = list(
        x = 71.5
      )
    )
  ) |>
  scr_arrows(
    facet = "Attention",
    length = 0.1,
    arrows = list(
      "A" = list(
        x0 = 7,
        x1 = 7,
        y0 = 1.5,
        y1 = 1
      ),
      "B" = list(
        x0 = 20,
        x1 = 20,
        y0 = 2.25,
        y1 = 2
      ),
      "C" = list(
        x0 = 31,
        x1 = 31,
        y0 = 2.25,
        y1 = 2
      )
    )
  ) |>
  scr_arrows(
    facet = "Demand",
    length = 0.1,
    arrows = list(
      "A" = list(
        x0 = 24,
        x1 = 24,
        y0 = 2.25,
        y1 = 1.5
      ),
      "B" = list(
        x0 = 36,
        x1 = 36,
        y0 = 1.3,
        y1 = 0.75
      ),
      "C" = list(
        x0 = 46,
        x1 = 46,
        y0 = 1.5,
        y1 = 0.75
      )
    )
  ) |>
  scr_brackets(
    facet = "Attention",
    length = 0.1,
    brackets = list(
      "A" = list(
        x0 = 8,
        x1 = 26,
        y0 = 3.3,
        y1 = 3
      ),
      "B" = list(
        x0 = 38,
        x1 = 76,
        y0 = 2.25,
        y1 = 1.5,
        lty = 3
      )
    )
  ) |>
  scr_brackets(
    facet = "Demand",
    length = 0.1,
    brackets = list(
      "A" = list(
        x0 = 23,
        x1 = 40,
        y0 = 3.3,
        y1 = 3
      ),
      "B" = list(
        x0 = 36,
        x1 = 47,
        y0 = 3.2,
        y1 = 2.9
      ),
      "C" = list(
        x0 = 29,
        x1 = 72,
        y0 = 1.25,
        y1 = 0.5,
        lty = 3
      )
    )
  ) |>
  scr_guide_line(
    color = "red",
    lty = 3,
    facet = "Attention",
    coords = list(
      "A" = list(
        x0 = 14,
        x1 = 25.5,
        y0 = 0.1
      ),
      "B" = list(
        x0 = 26.5,
        x1 = 100,
        y0 = 0.1
      )
    )
  ) |>
  scr_guide_line(
    color = "red",
    lty = 3,
    facet = "Demand",
    coords = list(
      "A" = list(
        x0 = 20,
        x1 = 100,
        y0 = 0.1
      )
    )
  )
```

## Gilroy et al. (2015)

### Results in Multiple Baseline Design

```{r ex_gilroy_et_al_2015, fig.width=9, fig.height=6, echo=FALSE}
data <- Gilroyetal2015

scr_plot(
  data,
  aesthetics = var_map(
    x = Session,
    y = Responding,
    p = Condition,
    facet = Participant
  ),
  mai = c(
    0.375,
    0.375,
    0.2,
    0.0
  ),
  omi = c(
    0.25,
    0.25,
    0.25,
    0.1
  )
) |>
  scr_xoverride(
    c(0.25, 27.5),
    xticks = 1:27,
    xtickslabs = as.character(1:27)
  ) |> # manually override x-axis (make extra room for labels)
  scr_yoverride(
    c(-5, 105), # manually override y-axis and tick interval (tick every 10 units)
    yticks = seq(0, 100, by = 10),
    ytickslabs = as.character(seq(0, 100, by = 10)),
  ) |>
  scr_points(
    cex = 2
  ) |> # plot points, using x/y from aesthetics
  scr_lines(
    size = 1
  ) |> # plot lines, using x/y from aesthetics
  scr_label_phase(
    facet = "Andrew", # plot labels on specific facet
    cex = 1.25,
    adj = 0.5,
    y = 107,
    labels = list( # list of labels to draw (will use assigned key for label)
      "Baseline" = list(
        x = 2.5
      ),
      "Treatment" = list(
        x = 9
      ),
      "Maintenance" = list(
        x = 19
      ),
      "Generalization" = list(
        x = 26
      )
    )
  ) |>
  scr_label_facet(
    cex = 1.5, # plot labels across facets (not within a single facet)
    adj = 1,
    y = 10,
    labels = list( # list of labels to draw (will use assigned key for label)
      "Andrew" = list(
        x = 27
      ),
      "Brian" = list(
        x = 27
      ),
      "Charles" = list(
        x = 27
      )
    )
  ) |>
  scr_plines_mbd(
    lines = list( # plot linked phase lines (note: drawn from top through bottom)
      "A" = list(
        "Andrew" = list(
          x1 = 4.5,
          y1 = 100
        ),
        "Brian" = list(
          x1 = 11.5,
          y1 = 100
        ),
        "Charles" = list(
          x1 = 18.5,
          y1 = 100,
          y2 = -5
        )
      ),
      "B" = list(
        "Andrew" = list(
          x1 = 13.5,
          y1 = 100
        ),
        "Brian" = list(
          x1 = 20.5,
          y1 = 100
        ),
        "Charles" = list(
          x1 = 23.5,
          y1 = 100,
          y2 = -5
        )
      ),
      "C" = list(
        "Andrew" = list(
          x1 = 23.5,
          y1 = 100
        ),
        "Brian" = list(
          x1 = 23.5,
          y1 = 100
        ),
        "Charles" = list(
          x1 = 23.5,
          y1 = 100,
          y2 = -5
        )
      )
    )
  ) |>
  scr_xlabel("Session") |> # Override x-axis label (bottom only shown by default)
  scr_ylabel("      Percent Accuracy") |> # Override y-axis label (centered, leftmost label)
  scr_title("Rates of Acquisition across Participants") |>
  scr_save(
    name = "../man/figures/multiplebaselinefigure.svg",
    format = "svg",
    units = "in",
    height = 6,
    width = 9
  )
```

# Automation of *fxl* in Clinical Reports

Apart from research applications and the benefits afforded by a purely programmatic means of building, generating, and archiving figures, these benefits also extend to various types of clinical applications as well. That is, any type of regularly collected data and form of educational programming that is common across students or cases can be visualized in a way that (1) reduces redundancy and eliminates the need for individual spreadsheets, (2) can be updated moment-to-moment with either the click of a button or as an automated process (e.g., run every morning before classes start), or (3) facilitates an overall view of the individual's behavior on its own and in comparison to the rest of the class/caseload.

## Integration with Quarto/RMarkdown

The ability to generate up-to-date reports and present data ready for visual analysis assists analysts in using data to inform their decisions as well as to learn more about present needs. Reports can be used to facilitate high-level reviews of behavior change (e.g., across center, school, grade level) as well as inspection of individual-level response to intervention and progress monitoring.

TODO

### High Level Example: Schoolwide Support

TODO

### High Level Example: Classroom Academics

```{r academics_grouped, fig.width=9, fig.height=8, echo=FALSE}
needFluency <- SimulatedAcademicFluency[SimulatedAcademicFluency$Times > 160 &
  SimulatedAcademicFluency$pred < 40 &
  SimulatedAcademicFluency$pred > 10, "index"]

needAccuracy <- SimulatedAcademicFluency[SimulatedAcademicFluency$Times > 160 &
  SimulatedAcademicFluency$pred < 10, "index"]

fluencyString <- paste("Consider Fluency Intervention:", paste(needFluency, collapse = ", "))
accuracyString <- paste("Consider Accuracy Intervention:", paste(needAccuracy, collapse = ", "))

labelList <- list()
labelList[[fluencyString]] <- list(
  x = 130,
  y = 11.5,
  color = "orange"
)
labelList2 <- list()
labelList2[[accuracyString]] <- list(
  x = 130,
  y = .115,
  color = "red"
)

scr_plot(
  SimulatedAcademicFluency,
  aesthetics = var_map(
    x = Times,
    y = pred,
    p = index
  ),
  omi = c(
    0.0,
    0.35,
    0.2,
    0.25
  ),
  mai = c(
    0.0,
    0.25,
    0.1,
    0.25
  ),
  semilog = TRUE
) |>
  scr_yoverride(c(0.1, 100)) |>
  scr_xoverride(c(1, 183),
    xticks = c(1, 30, 60, 90, 120, 150, 180),
    xtickslabs = c(
      "September",
      "October",
      "November",
      "December",
      "January",
      "February",
      "March"
    )
  ) |>
  scr_title("Addition Sums to 12: Monthly Class-wide Screening") |>
  scr_xlabel("Days Into Academic School Year") |>
  scr_ylabel("Digits Correct Per Minute (DCPM)") |>
  scr_guide_line(
    color = "green",
    lty = 1,
    lwd = 2,
    coords = list(
      "A" = list(
        x0 = -3,
        x1 = 190,
        y0 = 41,
        y1 = 41
      ),
      "B" = list(
        x0 = -3,
        x1 = 190,
        y0 = 100,
        y1 = 100
      ),
      "C" = list(
        x0 = -3,
        x1 = -3,
        y0 = 41,
        y1 = 100
      ),
      "D" = list(
        x0 = 190,
        x1 = 190,
        y0 = 41,
        y1 = 100
      )
    )
  ) |>
  scr_guide_line(
    color = "orange",
    lty = 1,
    lwd = 2,
    coords = list(
      "A" = list(
        x0 = -3,
        x1 = 190,
        y0 = 10,
        y1 = 10
      ),
      "B" = list(
        x0 = -3,
        x1 = 190,
        y0 = 39,
        y1 = 39
      ),
      "C" = list(
        x0 = -3,
        x1 = -3,
        y0 = 39,
        y1 = 10
      ),
      "D" = list(
        x0 = 190,
        x1 = 190,
        y0 = 39,
        y1 = 10
      )
    )
  ) |>
  scr_guide_line(
    color = "red",
    lty = 1,
    lwd = 2,
    coords = list(
      "A" = list(
        x0 = -3,
        x1 = 190,
        y0 = .1,
        y1 = .1
      ),
      "B" = list(
        x0 = -3,
        x1 = 190,
        y0 = 9.5,
        y1 = 9.5
      ),
      "C" = list(
        x0 = -3,
        x1 = -3,
        y0 = 9.5,
        y1 = .1
      ),
      "D" = list(
        x0 = 190,
        x1 = 190,
        y0 = 9.5,
        y1 = .1
      )
    )
  ) |>
  scr_lines() |>
  scr_points(
    pch = 21,
    fill = "white",
    cex = 1.5
  ) |>
  scr_label_phase(
    cex = 1,
    adj = 0,
    labels = labelList
  ) |>
  scr_label_phase(
    cex = 1,
    adj = 0,
    labels = labelList2
  ) |>
  scr_save(
    name = "../man/figures/celeration_academic.svg",
    format = "svg",
    units = "in",
    height = 6,
    width = 9
  )
```

### Low Level Inspection

```{r academics_individual, fig.width=9, fig.height=8, echo=FALSE}
hypotheticalReadingFluency <- data.frame(
  Time   = c(1, 30, 60, 90, 120, 150, 180, 210, 240),
  BM_ORF = c(73, NA, NA, NA, 105, NA, NA, NA, 114),
  ORF    = c(60, 64, 68, 72, 74, NA, NA, NA, NA),
  BM_WRF = c(40, NA, NA, NA, 50, NA, NA, NA, 55),
  WRF    = c(32, 33, 35, 36, 38, NA, NA, NA, NA),
  BM_MAZ = c(8, NA, NA, NA, 12, NA, NA, NA, 15.5),
  MAZ    = c(6, 6, 7, 8, 8, NA, NA, NA, NA)
)


scr_plot(
  hypotheticalReadingFluency,
  aesthetics = var_map(
    x = Time,
    y = ORF
  ),
  omi = c(
    0.0,
    0.35,
    0.2,
    0.25
  ),
  mai = c(
    0.0,
    0.25,
    0.1,
    0.25
  ),
  semilog = TRUE
) |>
  scr_yoverride(c(1, 1000)) |>
  scr_xoverride(c(1, 243),
    xticks = c(1, 30, 60, 90, 120, 150, 180, 210, 240),
    xtickslabs = c(
      "September",
      "October",
      "November",
      "December",
      "January",
      "February",
      "March",
      "April",
      "May"
    )
  ) |>
  scr_title("Response-to-Intervention: Core Reading Indicators") |>
  scr_xlabel("Days Into Academic School Year") |>
  scr_ylabel("Fluency") |>
  scr_guide_line(
    lty = 1,
    coords = list(
      "ORF" = list(
        x0 = 120,
        x1 = 240,
        y0 = 74,
        y1 = 114,
        col = "green",
        lty = 2,
        lwd = 2.5
      ),
      "WRF" = list(
        x0 = 120,
        x1 = 240,
        y0 = 38,
        y1 = 55,
        col = "orange",
        lty = 2,
        lwd = 2.5
      ),
      "MAX" = list(
        x0 = 120,
        x1 = 240,
        y0 = 8,
        y1 = 15.5,
        col = "blue",
        lty = 2,
        lwd = 2.5
      )
    )
  ) |>
  scr_points(
    pch = 23,
    fill = "green",
    cex = 3,
    mapping = var_map(
      x = Time,
      y = BM_ORF
    )
  ) |>
  scr_points(
    pch = 23,
    fill = "orange",
    cex = 3,
    mapping = var_map(
      x = Time,
      y = BM_WRF
    )
  ) |>
  scr_points(
    pch = 23,
    fill = "blue",
    cex = 3,
    mapping = var_map(
      x = Time,
      y = BM_MAZ
    )
  ) |>
  scr_lines(size = 1) |>
  scr_points(
    pch = 21,
    fill = "green",
    cex = 3
  ) |>
  scr_lines(
    color = "black",
    mapping = var_map(
      x = Time,
      y = WRF
    )
  ) |>
  scr_points(
    pch = 21,
    fill = "orange",
    cex = 3,
    mapping = var_map(
      x = Time,
      y = WRF
    )
  ) |>
  scr_lines(
    color = "black",
    mapping = var_map(
      x = Time,
      y = MAZ
    )
  ) |>
  scr_points(
    pch = 21,
    fill = "blue",
    cex = 3,
    mapping = var_map(
      x = Time,
      y = MAZ
    )
  ) |>
  scr_label_phase(
    cex = 1.5,
    adj = 0,
    labels = list(
      "ORF Intervention Started" = list(
        color = "green",
        x = 122.5,
        y = 135
      )
    )
  ) |>
  scr_label_phase(
    cex = 1.5,
    adj = 0,
    labels = list(
      "WRF Intervention Started" = list(
        color = "orange",
        x = 122.5,
        y = 27.5
      )
    )
  ) |>
  scr_label_phase(
    cex = 1.5,
    adj = 0,
    labels = list(
      "MAZ Intervention Started" = list(
        color = "blue",
        x = 122.5,
        y = 6
      )
    )
  ) |>
  scr_label_phase(
    cex = 1.5,
    adj = 0,
    labels = list(
      "Note (1/15/23): Started Tier II Intervention" = list(
        x = 122.5,
        y = 1.5
      )
    )
  ) |>
  scr_legend(
    position = "topright", # Specify legend location
    legend = c(
      "Median Expectation: Oral Reading Fluency (ORF) - Words Correct",
      "Oral Reading Fluency (ORF) - Words Correct",
      "Median Expectation: Word Reading Fluency (WRF)",
      "Word Reading Fluency (WRF)",
      "Median Expectation: Maze (MAZ)",
      "Maze (MAZ)"
    ),
    col = c("black", "black", "black", "black", "black", "black"),
    pt_bg = c(
      "green", "green",
      "orange", "orange",
      "blue", "blue"
    ),
    bg = "white",
    lty = c(
      NA,
      1,
      NA,
      1,
      NA,
      1
    ),
    pch = c(
      23,
      21,
      23,
      21,
      23,
      21
    ),
    bty = "y",
    pt_cex = 2.25,
    cex = 1.5,
    text_col = "black",
    horiz = FALSE,
    box_lty = 1
  ) |>
  scr_save(
    name = "../man/figures/celeration_academic_rti.svg",
    format = "svg",
    units = "in",
    height = 7,
    width = 9
  )
```
